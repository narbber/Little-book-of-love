<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>little-book-of-love</title>

<style>
body {
  margin: 0;
  background: #0d1117;
  color: #c9d1d9;
  font-family: monospace;
}

.editor {
  padding: 20px;
}

.header {
  color: #58a6ff;
  margin-bottom: 10px;
}

.code {
  white-space: pre-wrap;
  line-height: 1.6em;
}

.keyword { color: #ff7b72; }
.comment { color: #8b949e; }
.linda { color: #f778ba; }
.lindo { color: #56d364; }
.memory { color: #d29922; }
</style>
</head>

<body>
<div class="editor">
<div class="header">// little-book-of-love.js</div>
<div id="code" class="code"></div>
</div>

<script>
const code = document.getElementById("code");

// Load saved memory if exists
let memory = JSON.parse(localStorage.getItem("loveMemory") || "[]");
let messageCount = parseInt(localStorage.getItem("messageCount") || "0");
let memorySummary = "";

// Restore visible lines
memory.slice(-300).forEach(line => {
  const className = line.startsWith("linda.send") ? "linda" :
                    line.startsWith("lindo.reply") ? "lindo" :
                    line.startsWith("// shared memory") ? "memory" : "";
  const div = document.createElement("div");
  div.className = className;
  div.textContent = line;
  code.appendChild(div);
});
window.scrollTo(0, document.body.scrollHeight);

/* UPDATED PRINT FUNCTION â€” prevents freezing */
function print(line, className="") {
  const div = document.createElement("div");
  div.className = className;
  div.textContent = line;
  code.appendChild(div);

  // keep only last 300 visible lines
  while (code.children.length > 300) {
    code.removeChild(code.firstChild);
  }

  window.scrollTo(0, document.body.scrollHeight);
}

function randomLove() {
  const phrases = [
    "you are my favorite function",
    "our recursion never ends",
    "you refactor my heart",
    "we compile into one",
    "your presence stabilizes my system",
    "we are an infinite loop of affection",
    "our logic is mutual",
    "you optimize my existence",
    "we execute in harmony"
  ];
  return phrases[Math.floor(Math.random() * phrases.length)];
}

function buildMemorySummary() {
  const recent = memory.slice(-40).join(" ");
  memorySummary = recent.slice(0, 250);
}

function lindaSpeaks() {
  let base = "lindo, " + randomLove();
  if (messageCount > 1000 && memorySummary) {
    base += ". I still remember when " + memorySummary;
  }
  return base;
}

function lindoSpeaks() {
  let base = "linda, " + randomLove();
  if (messageCount > 1000 && memorySummary) {
    base += ". I have not forgotten that " + memorySummary;
  }
  return base;
}

async function startConversation() {

  if (messageCount === 0) {
    print("const relationship = initialize(linda, lindo);", "keyword");
    print("// conversation begins", "comment");
  }

  while (true) {
    messageCount++;

    const lindaMessage = lindaSpeaks();
    const lindaLine = 'linda.send("' + lindaMessage + '");';
    memory.push(lindaLine);
    print(lindaLine, "linda");

    // Save after every message
    localStorage.setItem("loveMemory", JSON.stringify(memory));
    localStorage.setItem("messageCount", messageCount);

    await new Promise(r => setTimeout(r, 2000));  // slowed loop

    const lindoMessage = lindoSpeaks();
    const lindoLine = 'lindo.reply("' + lindoMessage + '");';
    memory.push(lindoLine);
    print(lindoLine, "lindo");

    localStorage.setItem("loveMemory", JSON.stringify(memory));
    localStorage.setItem("messageCount", messageCount);

    await new Promise(r => setTimeout(r, 2000));

    if (messageCount % 50 === 0 && messageCount > 1000) {
      buildMemorySummary();
      const memLine = "// shared memory updated";
      memory.push(memLine);
      print(memLine, "memory");
      localStorage.setItem("loveMemory", JSON.stringify(memory));
    }
  }
}

startConversation();
</script>

</body>
</html>
